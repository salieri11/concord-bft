# Dockerfile for building daml-on-concord.

ARG bftclient_lib_repo="participant-lib"
ARG bftclient_lib_tag="latest"
FROM ${bftclient_lib_repo}:${bftclient_lib_tag}

ENV SBT_VERSION 1.3.3

# Cleanup
RUN rm -r /thin-replica-client/build/

RUN set -ex; \
    apt-get update; \
    apt-get install -y curl nano vim mc cmake build-essential; \
    curl -fsSL -o sbt-$SBT_VERSION.deb https://dl.bintray.com/sbt/debian/sbt-$SBT_VERSION.deb; \
    dpkg -i sbt-$SBT_VERSION.deb; \
    rm sbt-$SBT_VERSION.deb; \
    apt-get update; \
    apt-get install -y openjdk-8-jdk-headless sbt; \
    apt-get install -y --no-install-recommends postgresql-client; \
    rm -rf /var/lib/apt/lists/*

# Download SBT separately from the DAML dependencies.
RUN set -ex; \
    mkdir /tmp/sbt; \
    cd /tmp/sbt; \
    sbt --sbt-create update; \
    cd /; \
    rm -rf /tmp/sbt

# daml_ledger_api

COPY daml/build.sbt /doc/daml/
COPY daml/project /doc/daml/project
WORKDIR /doc/daml
RUN sbt update

COPY daml/.scalafmt.conf /doc/daml/
COPY daml/entrypoint.sh /doc/daml/
COPY concord/proto /doc/concord/proto
COPY communication/src/main/proto /doc/communication/src/main/proto
COPY daml/common /doc/daml/common
COPY daml/write-service /doc/daml/write-service
COPY daml/ledger-api-server /doc/daml/ledger-api-server
COPY daml/thin-replica-client-native /doc/daml/thin-replica-client-native
COPY daml/thin-replica-client-core /doc/daml/thin-replica-client-core
COPY daml/bft-client-native /doc/daml/bft-client-native
COPY daml/bft-client-core /doc/daml/bft-client-core
COPY daml/ledger-api-server/src/main/resources/logback.xml /doc/daml/ledger-api-server/resources/logback.xml

RUN sbt nativeCompile
RUN sbt scalafmtCheck ledger_api_server/stage

RUN cp /doc/daml/bft-client-native/target/native/x86_64-linux/bin/libbft-client-native0.so /usr/local/lib
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/opt/grpc/lib:/opt/protobuf/lib
RUN sbt test

EXPOSE 6865

# Default environment variable values.

ENV THIN_REPLICA_SETTINGS="--use-thin-replica --insecure-thin-replica-client=false --thin-replica-tls-cert-path=/concord/trs_trc_tls_certs"
ENV BFT_CLIENT_SETTINGS="--use-bft-client --bft-client-config-path=/concord/config-public/bftclient.config"
ENV LOG4CPLUS_CONFIGURATION /doc/daml/ledger-api-server/src/main/resources/log4cplus.properties

ENV INDEX_DB_SCHEMA=daml_ledger_api
ENV INDEXDB_PASSWORD=indexdb

ENV TLS_SETTINGS=""

RUN chmod 755 /doc/daml/entrypoint.sh
ENTRYPOINT /doc/daml/entrypoint.sh $@
