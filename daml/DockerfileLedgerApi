# Dockerfile for building daml-on-concord.

# daml_ledger_api

ARG trc_lib_repo="trc-lib"
ARG trc_lib_tag="latest"
FROM ${trc_lib_repo}:${trc_lib_tag}

ENV SBT_VERSION 1.3.0

RUN apt update && apt install -y curl && \
    curl -L -o sbt-$SBT_VERSION.deb https://dl.bintray.com/sbt/debian/sbt-$SBT_VERSION.deb && \
    dpkg -i sbt-$SBT_VERSION.deb && \
    rm sbt-$SBT_VERSION.deb && \
    apt update && apt install -y openjdk-8-jdk-headless sbt && \
    apt install -y --no-install-recommends postgresql-client && \
    rm -rf /var/lib/apt/lists/*

COPY daml/build.sbt /doc/daml/
COPY daml/project /doc/daml/project
COPY daml/.scalafmt.conf /doc/daml/
WORKDIR /doc/daml
RUN sbt update

COPY daml/entrypoint.sh /doc/daml/entrypoint.sh
COPY concord/proto /doc/concord/proto
COPY communication/src/main/proto /doc/communication/src/main/proto
COPY daml/common /doc/daml/common
COPY daml/write-service /doc/daml/write-service
COPY daml/ledger-api-server /doc/daml/ledger-api-server
COPY daml/thin-replica-client-native /doc/daml/thin-replica-client-native
COPY daml/thin-replica-client-core /doc/daml/thin-replica-client-core

RUN sbt nativeCompile
RUN sbt scalafmtCheck ledger_api_server/stage
RUN rm -r /thin-replica-client/build/
EXPOSE 6865

ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/opt/grpc/lib:/opt/protobuf/lib
ENV THIN_REPLICA_SETTINGS="--use-thin-replica"
ENV LOG4CPLUS_CONFIGURATION /doc/daml/ledger-api-server/src/main/resources/log4cplus.properties

RUN chmod 755 /doc/daml/entrypoint.sh
ENTRYPOINT /doc/daml/entrypoint.sh $@
