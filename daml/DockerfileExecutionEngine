# Dockerfile for building daml-on-concord.

# daml_execution_engine

FROM ubuntu:18.04

ENV SBT_VERSION 1.3.3

RUN set -ex; \
    apt-get update; \
    apt-get install -y curl unzip; \
    curl -fsSL -o sbt-$SBT_VERSION.deb https://dl.bintray.com/sbt/debian/sbt-$SBT_VERSION.deb; \
    dpkg -i sbt-$SBT_VERSION.deb; \
    rm sbt-$SBT_VERSION.deb; \
    apt-get update; \
    apt-get install -y openjdk-8-jdk-headless sbt; \
    apt-get install -y --no-install-recommends postgresql-client; \
    rm -rf /var/lib/apt/lists/*

# Download buf
ENV BUF_VERSION v0.31.1
RUN set -ex; \
    curl -fsSL -o /usr/local/bin/buf "https://github.com/bufbuild/buf/releases/download/${BUF_VERSION}/buf-$(uname -s)-$(uname -m)"; \
    chmod +x /usr/local/bin/buf

# Download SBT separately from the DAML dependencies.
RUN set -ex; \
    mkdir /tmp/sbt; \
    cd /tmp/sbt; \
    sbt --sbt-create update; \
    cd /; \
    rm -rf /tmp/sbt

COPY daml/build.sbt daml/integration-kit-suffix.version daml/sdk.version /doc/daml/
COPY daml/project /doc/daml/project
COPY daml/.scalafmt.conf /doc/daml/
WORKDIR /doc/daml
RUN sbt update

COPY concord/proto /doc/concord/proto
COPY communication/src/main/proto /doc/communication/src/main/proto
COPY daml/execution-engine /doc/daml/execution-engine
COPY daml/common /doc/daml/common
COPY daml/daml-execution-engine-entrypoint.sh /doc/daml/entrypoint.sh

# Common logging configuration, also pointed at by path in `daml/execution-engine/src/main/resources/logback.xml`
COPY daml/common/src/main/resources/logback-common.xml /doc/daml/execution-engine/resources/logback-common.xml

COPY daml/execution-engine/src/main/resources/logback.xml /doc/daml/execution-engine/resources/logback.xml

RUN sbt execution_engine/scalafmtCheck execution_engine/stage

# Verify that the protobufs are compatible.
COPY daml/buf-test.sh /doc/daml/
RUN /doc/daml/buf-test.sh

RUN sbt execution_engine/test

EXPOSE 55000

RUN chmod 755 /doc/daml/entrypoint.sh

ENTRYPOINT ["/doc/daml/entrypoint.sh"]

CMD ["-J-Xmx4G"]
