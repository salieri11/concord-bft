<html>
<head>
  <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
  <title>DAML on VMware Execution Engine Dashboard</title>

  <!-- TODO(JM): All of these should be vendored to make the dashboard usable without internet access. -->

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href='https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.15.6/metricsgraphics.min.css' rel='stylesheet' type='text/css'>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <script src='https://d3js.org/d3.v4.min.js' charset='utf-8'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.15.6/metricsgraphics.min.js'></script>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">DAML on VMware Execution Engine Dashboard</a>
  </nav>

  <div style="margin: 5px" class='container-fluid'>
    <div class="row">
      <h3>JVM Garbage Collection</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='jvm_mem_heap_used'></div>
      <div class="col-sm" id='jvm_mem_total_used'></div>
      <div class="col-sm" id='jvm_mem_heap_usage'></div>
    </div>
    <div class="row">
      <div class="col-sm" id='jvm_gc_og_time'></div>
      <div class="col-sm" id='jvm_gc_og_count'></div>
    </div>
    <div class="row">
      <div class="col-sm" id='jvm_gc_yg_time'></div>
      <div class="col-sm" id='jvm_gc_yg_count'></div>
    </div>

    <div class="row">
      <h3>Validator state caching</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='validator_cache_hits'></div>
      <div class="col-sm" id='validator_cache_misses'></div>
      <div class="col-sm" id='validator_cache_evictions'></div>
    </div>

    <div class="row">
      <h3>Validator requests</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='validator_service_validate_time'></div>
      <div class="col-sm" id='validator_service_validate_pending_time'></div>
      <div class="col-sm" id='validator_service_submission_sizes'></div>
    </div>
    <div class="row">
      <div class="col-sm" id='validator_service_output_sizes'></div>
      <div class="col-sm" id='validator_service_missing_inputs'></div>
    </div>

    <div class="row">
      <h3>Transactions</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='kvutils_transaction_rejections'></div>
      <div class="col-sm" id='kvutils_transaction_run_time'></div>
      <div class="col-sm" id='kvutils_transaction_interpret_time'></div>
    </div>

    <div class="row">
      <h3>Packages</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='kvutils_package_count'></div>
      <div class="col-sm" id='kvutils_package_run_time'></div>
    </div>
    <div class="row">
      <div class="col-sm" id='kvutils_package_preload_time'></div>
      <div class="col-sm" id='kvutils_package_decode_time'></div>
    </div>

    <div class="row">
      <h3>KeyValueCommitting</h3>
    </div>
    <div class="row">
      <div class="col-sm" id='kvutils_exceptions'></div>
      <div class="col-sm" id='kvutils_processing'></div>
    </div>
    <div class="row">
      <h3>Last kvutils submission</h3>
      <table class="table table-sm">
        <tbody>
        <tr>
          <th scope="row">Entry id:</th>
          <td><div id='kvutils_last_entry_id'></div></td>
        <tr>
        <tr>
          <th scope="row">Record time:</th>
          <td><div id='kvutils_last_record_time'></div></td>
        </tr>
        <tr>
          <th scope="row">Participant id:</th>
          <td><div id='kvutils_last_participant_id'></div></td>
        </tr>
        <tr>
          <th scope="row">Last seen exception:</th>
          <td><div id='kvutils_last_exception'></div></td>
        </tr>
      </table>
    </div>

  </div>

  <script>

  function make_graph(target, title, description, y) {
    return data => {
      let format = (y == "percentage") ? y : undefined;
      return {
          title: title,
          description: description,
          utc_time: true,
          width: 550,
          height: 250,
          left: 90,
          target: target,
          x_accessor: 'time',
          y_accessor: y,
          data: data,
          y_label: y,
          y_extended_ticks: true,
          format: format
      };
    };
  }

  function percentile_data(obj) {
    return [
      {bin: 'min', value: obj.min},
      {bin: 'p50', value: obj.p50},
      {bin: 'p95', value: obj.p95},
      {bin: 'max', value: obj.max}
    ];
  }

  function make_percentiles(target, title) {
    return data => {
      return {
          chart_type: 'bar',
          title: title,
          description: title,
          animate_on_load: true,
          width: 550,
          height: 250,
          target: target,
          binned: true,
          x_accessor: 'bin',
          y_accessor: 'value',
          data: data,
          padding_percentage: 0,
      };
    };
  }

  function rejections_data(obj, prefix) {
    return d3.keys(obj)
      .filter(k => k.startsWith(prefix))
      .map(k => {
        return {
          reason: k.substring(prefix.length),
          value: obj[k].count
        }
      });
  }

  function make_rejections(target, title) {
    return data => {
      return {
          chart_type: 'bar',
          title: title,
          description: title,
          animate_on_load: true,
          width: 550,
          height: 250,
          left: 100,
          target: target,
          y_accessor: 'reason',
          x_accessor: 'value',
          data: data,
      };
    };
  }

  var metrics = {
   "jvm.mem.heap.used": {
     make: make_graph("#jvm_mem_heap_used", "Heap Used", "Number of bytes of JVM heap used", "bytes"),
     data: []
   },

   "jvm.mem.total.used": {
     make: make_graph("#jvm_mem_total_used", "Memory Used", "Number of bytes allocated from OS", "bytes"),
     data: []
   },

   "jvm.mem.heap.usage": {
     make: make_graph("#jvm_mem_heap_usage", "Heap Usage", "How much in use from available heap", "percentage"),
     data: []
   },

   "jvm.gc.og.time": {
     make: make_graph("#jvm_gc_og_time", "GC Old Generation Time", "ms"),
     data: []
   },

   "jvm.gc.og.count": {
     make: make_graph("#jvm_gc_og_count", "GC Old Generation Count", "count"),
     data: []
   },

   "jvm.gc.yg.time": {
     make: make_graph("#jvm_gc_yg_time", "GC Young Generation Time", "Young generation GC cumulative time spent", "ms"),
     data: []
   },

   "jvm.gc.yg.count": {
     make: make_graph("#jvm_gc_yg_count", "GC Young Generation Count", "Number of times GC has been ran", "count"),
     data: []
   },

   "validator.cache.hits": {
     make: make_graph("#validator_cache_hits", "Cache hits", "Number of times input state was found from cache", "hits"),
     data: []
   },

   "validator.cache.misses": {
     make: make_graph("#validator_cache_misses", "Cache misses", "Number of times input was missing and was requested from concord", "misses"),
     data: []
   },

   "validator.cache.evictions": {
     make: make_graph("#validator_cache_evictions", "Cache evictions", "Number of cache entries evicted", "evictions"),
     data: []
   },

   "kvutils.exceptions": {
     make: make_graph("#kvutils_exceptions", "Exceptions", "Number of exceptions from kvutils", "count"),
     data: []
   },

   "kvutils.processing": {
     make: make_graph("#kvutils_processing", "Processing", "Number of active submission processes", "count"),
     data: []
   },

   "kvutils.package.count": {
     make: make_graph("#kvutils_package_count", "Package submissions", "Number of package submissions handled", "count"),
     data: []
   },

   "kvutils.package.run-time": {
     make: make_percentiles("#kvutils_package_run_time", "Package run percentiles"),
     data: []
   },

   "kvutils.transaction.run-time": {
     make: make_percentiles("#kvutils_transaction_run_time", "Transaction run percentiles (seconds)"),
     data: []
   },

   "kvutils.transaction.interpret-time": {
     make: make_percentiles("#kvutils_transaction_interpret_time", "Transaction interpret percentiles (seconds)"),
     data: []
   },

   "kvutils.transaction.rejections": {
     make: make_rejections("#kvutils_transaction_rejections", "Transaction rejections"),
     data: []
   },

   "kvutils.package.preload-time": {
     make: make_percentiles("#kvutils_package_preload_time", "Package preload percentiles (seconds)"),
     data: []
   },

   "kvutils.package.decode-time": {
     make: make_percentiles("#kvutils_package_decode_time", "Package decoding percentiles (seconds)"),
     data: []
   },

   "validator.service.validate-time": {
     make: make_percentiles("#validator_service_validate_time", "Validate percentiles (seconds)"),
     data: []
   },

   "validator.service.validate-pending-time": {
     make: make_percentiles("#validator_service_validate_pending_time", "ValidatePending percentiles (seconds)"),
     data: []
   },

   "validator.service.submission-sizes": {
     make: make_percentiles("#validator_service_submission_sizes", "Submission sizes (bytes)"),
     data: []
   },

   "validator.service.output-sizes": {
     make: make_percentiles("#validator_service_output_sizes", "Output sizes (bytes)"),
     data: []
   },

   "validator.service.missing-inputs": {
     make: make_percentiles("#validator_service_missing_inputs", "Missing inputs"),
     data: []
   }
  };

  function push(now, dest, y, value) {
    // Keep last 50 data points.
    dest.data.slice(-50);
    var entry = {time: now};
    entry[y] = value;
    dest.data.push(entry);
  }

  function update() {
    d3.json('/admin/metrics', function(data) {
      let now = new Date();

      push(now, metrics["jvm.mem.heap.used"], "bytes", data.gauges["jvm.mem.heap.used"].value);
      push(now, metrics["jvm.mem.total.used"], "bytes", data.gauges["jvm.mem.total.used"].value);
      push(now, metrics["jvm.mem.heap.usage"], "percentage", data.gauges["jvm.mem.heap.usage"].value);

      push(now, metrics["jvm.gc.og.time"], "ms", data.gauges["jvm.gc.G1-Old-Generation.time"].value);
      push(now, metrics["jvm.gc.og.count"], "count", data.gauges["jvm.gc.G1-Old-Generation.count"].value);

      push(now, metrics["jvm.gc.yg.time"], "ms", data.gauges["jvm.gc.G1-Young-Generation.time"].value);
      push(now, metrics["jvm.gc.yg.count"], "count", data.gauges["jvm.gc.G1-Young-Generation.count"].value);

      // NOTE(JM): Catching exceptions in each group as some metrics only show up later and we still
      // want to render what we can.

      try {
        push(now, metrics["validator.cache.hits"], "hits", data.counters["validator.cache.hits"].count);
        push(now, metrics["validator.cache.misses"], "misses", data.counters["validator.cache.misses"].count);
        push(now, metrics["validator.cache.evictions"], "evictions", data.counters["validator.cache.evictions"].count);
      } catch (e) {
        console.log("validator.cache metrics missing: " + e);
      }

      try {
        push(now, metrics["kvutils.processing"], "count", data.counters["kvutils.committing.processing"].count);
        push(now, metrics["kvutils.exceptions"], "count", data.counters["kvutils.committing.exceptions"].count);
      } catch (e) {
        console.log("kvutils metrics missing: " + e);
      }

      try {
        push(now, metrics["kvutils.package.count"], "count", data.timers["kvutils.committing.package.run-timer"].count);

        metrics["kvutils.package.run-time"].data =
          percentile_data(
            data.timers["kvutils.committing.package.run-timer"]
          );

        metrics["kvutils.package.preload-time"].data =
          percentile_data(
            data.timers["kvutils.committing.package.preload-timer"]
          );

        metrics["kvutils.package.decode-time"].data =
          percentile_data(
            data.timers["kvutils.committing.package.decode-timer"]
          );
      } catch (e) {
        console.log("kvutils.package metrics missing: " + e);
      }

      try {
        metrics["kvutils.transaction.run-time"].data =
          percentile_data(
            data.timers["kvutils.committing.transaction.run-timer"]
          );

        metrics["kvutils.transaction.interpret-time"].data =
          percentile_data(
            data.timers["kvutils.committing.transaction.interpret-timer"]
          );

        metrics["kvutils.transaction.rejections"].data =
          rejections_data(
            data.counters,
            "kvutils.committing.transaction.rejections_");
      } catch (e) {
        console.log("kvutils.transaction metrics missing:" + e);
      }

      try {
        metrics["validator.service.validate-time"].data =
          percentile_data(
            data.timers["validator.service.validate-timer"]
          );
        metrics["validator.service.validate-pending-time"].data =
          percentile_data(
            data.timers["validator.service.validate-pending-timer"]
          );
        metrics["validator.service.submission-sizes"].data =
          percentile_data(
            data.histograms["validator.service.submission-sizes"]
          );

        metrics["validator.service.output-sizes"].data =
          percentile_data(
            data.histograms["validator.service.output-sizes"]
          );

        metrics["validator.service.missing-inputs"].data =
          percentile_data(
            data.histograms["validator.service.missing-inputs"]
          );
      } catch (e) {
        console.log("validator.service metrics missing: " + e);
      }

      try {
        $('#kvutils_last_exception').html(
          "<pre>" + data.gauges["kvutils.committing.last.exception"].value + "</pre>");

        $('#kvutils_last_entry_id').html(
          "<pre>" + data.gauges["kvutils.committing.last.entry-id"].value + "</pre>");

        $('#kvutils_last_participant_id').html(
          "<pre>" + data.gauges["kvutils.committing.last.participant-id"].value + "</pre>");

        $('#kvutils_last_record_time').html(
          "<pre>" + data.gauges["kvutils.committing.last.record-time"].value + "</pre>");
      } catch(e) {
        console.log("kvutils gauges missing: " + e);
      }

      for (let k in metrics) {
        let metric = metrics[k];
        if (metric.data.length > 0) {
          MG.data_graphic(metric.make(metric.data));
        }
      }
    });
  }
  update();
  setInterval(update, 5000);

  </script>
</body>
</html>


