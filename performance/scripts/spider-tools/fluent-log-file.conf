<source>
  @type tail
  <parse>
    @type json
  </parse>
  path /var/lib/docker/containers/*/*-json.log
  pos_file /var/log/fluentd-docker.pos
  read_from_head true
  tag docker.*
  refresh_interval 5s
  enable_stat_watcher false
</source>

<filter docker.var.lib.docker.containers.**.*>
  @type record_modifier
  <record>
    service_name ${id = tag_parts[5]; JSON.parse(IO.read("/var/lib/docker/containers/#{id}/config.v2.json"))['Name'][1..-1]}
    consortium_id "#{ENV['CONSORTIUM_ID']}"
  </record>
</filter>

<match docker.var.lib.docker.containers.**.*>
  @type rewrite_tag_filter
  <rule>
    key service_name
    pattern /^(.+)$/
    tag $1
  </rule>
</match>

<match ledger-party-setup-** upload-dar-** package-warm-** market-setup-** import-data-set-** spider-** load-runner-**>
  @type file
  path /var/log/fluent/${consortium_id}/${service_name}
  append true
  <buffer consortium_id,service_name>
    @type memory
  </buffer>
  <format>
    @type single_value
    message_key log
    add_newline false
  </format>
</match>
