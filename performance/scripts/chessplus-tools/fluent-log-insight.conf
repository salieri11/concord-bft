<source>
  @type tail
  <parse>
    @type json
    time_type string
    time_format "%Y-%m-%dT%H:%M:%S.%NZ"
  </parse>
  path /var/lib/docker/containers/*/*-json.log
  pos_file /var/log/fluentd-docker.pos
  read_from_head true
  tag docker.*
  refresh_interval 5s
  enable_stat_watcher false
</source>

<filter docker.var.lib.docker.containers.**.*>
  @type record_modifier
  <record>
    service_name ${id = tag_parts[5]; JSON.parse(IO.read("/var/lib/docker/containers/#{id}/config.v2.json"))['Name'][1..-1].gsub(/[^a-z]*$/, '')}
    consortium_id "#{ENV['CONSORTIUM_ID']}"
  </record>
</filter>

<match docker.var.lib.docker.containers.**.*>
  @type rewrite_tag_filter
  <rule>
    key service_name
    pattern /^(.+)$/
    tag $1
  </rule>
</match>

<match spider upload-dar package-warm market-setup import-data-set load-runner telegraf wavefront>
  @type copy
  <store>
    @type file
    path /var/log/fluent/${service_name}
    append true
    <buffer service_name>
      @type memory
    </buffer>
    <format>
      @type single_value
      message_key log
      add_newline false
    </format>
  </store>

  <store>
    @type vmware_loginsight
    scheme https
    ssl_verify false
    host "#{ENV['LOG_INSIGHT_HOST']}"
    port "#{ENV['LOG_INSIGHT_PORT']}"
    path api/v1/events/ingest
    agent_id "#{ENV['LOG_INSIGHT_AGENT_ID']}"
    http_method post
    serializer json
    rate_limit_msec 0
    raise_on_error false
    include_tag_key false
    authentication basic
    username "#{ENV['LOG_INSIGHT_USERNAME']}"
    password "#{ENV['LOG_INSIGHT_PASSWORD']}"
  </store>
</match>
