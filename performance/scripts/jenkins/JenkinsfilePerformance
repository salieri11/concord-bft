@Library('PipelineWorks@master')

import com.vmware.pipelineworks.Artifactory
import com.vmware.pipelineworks.GitLab
import com.vmware.pipelineworks.Performance
import com.vmware.pipelineworks.Python

pipeline {
  agent any

  parameters {
    string(name: "build", defaultValue: "", description: "Leave blank for the latest, or enter the exact build to use.")
    string(name: "jenkins_branch", defaultValue: "master", description: "Where to fetch the code which handles the mechanics of launching this Jenkins job.")
  }

  stages{
    stage("Get Source"){
      steps{
        script {
          dir('blockchain') {
            new GitLab().checkoutRepo(
                "git@gitlab.eng.vmware.com:blockchain/vmwathena_blockchain.git",
                params.jenkins_branch)
          }
        }
      }
    }


    stage("Init Libs") {
      steps {
        script {
          dir('blockchain') {
            new Python().initializePython()
          }
        }
      }
    }


    stage("Get Build"){
      steps{
        script{
          if(params.build && params.build.trim()){
            env.product_version = params.build.trim()
          }else{
            dir('blockchain'){
              env.product_version = new Artifactory().getLatestTag()
            }
          }
        }
      }
    }


    stage("Launch Maestro Client"){
      steps{
        script{
          dir('blockchain'){
            new Performance().startPerformanceRun()
          }
        }
      }
    }
  }
}
