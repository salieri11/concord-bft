#!/bin/sh
echo -e "c0nc0rd\nc0nc0rd" | /bin/passwd

echo -e "[Match]\nName=eth0\n\n[Network]\nAddress=10.0.0.10/24\nGateway=10.0.0.1\nDNS=\nIPv6AcceptRA=false" > /etc/systemd/network/10-eth0-static.network; chmod 644 /etc/systemd/network/10-eth0-static.network; systemctl restart systemd-networkd;

sed -i 's_/usr/bin/dockerd.*_/usr/bin/dockerd --dns  -H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock _g' /lib/systemd/system/docker.service

export http_proxy=http://outbound:1234;export https_proxy=https://outbound:12345;mkdir /etc/systemd/system/docker.service.d;echo -e '[Service]\nEnvironment="HTTP_PROXY=http://http://outbound:1234"\nEnvironment="HTTPS_PROXY=http://outbound:12345"\nEnvironment="NO_PROXY=localhost,127.0.0.1"' > /etc/systemd/system/docker.service.d/http-proxy.conf
systemctl daemon-reload

mkdir -p /etc/docker
echo '{"log-driver": "json-file", "log-opts": { "max-size": "100m", "max-file": "5"}}' > /etc/docker/daemon.json

systemctl restart docker

# To enable docker on boot.
systemctl enable docker

# Enable time sync
vmware-toolbox-cmd timesync enable

# Partition, format, and mount additional disk, if any


# Output the node's model specification.
mkdir -p /config/agent
echo '{
}' > /config/agent/config.json

# Update guest-info's network information in vSphere.
touch /etc/vmware-tools/tools.conf
printf '[guestinfo]\nprimary-nics=eth*\nexclude-nics=docker*,veth*' > /etc/vmware-tools/tools.conf
/usr/bin/vmware-toolbox-cmd info update network

# Retry logic to pull an image.
retry=0
until [ $retry -ge 3 ]
do
   docker login https://containerRegistry.com -u username -p 'password'
   docker network create -d bridge blockchain-fabric
   docker run -d --name=agent --restart=always --network=blockchain-fabric -p 127.0.0.1:8546:8546 -v /config:/config -v /var/run/docker.sock:/var/run/docker.sock containerRegistry.com/agent && break
   retry=$[$retry+1]
   sleep 10
done

echo 'done'